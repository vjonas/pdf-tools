<div class="app-container">
  <!-- Toolbar -->
  <p-toolbar>
    <div class="p-toolbar-group-start flex gap-1">
      <p-button icon="pi pi-folder-open"
                label="Open PDF"
                (click)="openPdf()"
                [disabled]="pdfService.isLoading()"
                class="p-button-outlined mr-2">
      </p-button>

      <p-button icon="pi pi-save"
                label="Save PDF"
                (click)="savePdf()"
                [disabled]="!pdfService.currentFileName() || pdfService.isLoading()"
                class="p-button-outlined mr-2">
      </p-button>

      <p-button icon="pi pi-copy"
                label="Split PDF"
                (click)="showSplitDialog = true"
                [disabled]="pdfService.pages().length === 0"
                class="p-button-outlined mr-2">
      </p-button>
    </div>

    <div class="p-toolbar-group-end justify-self-end">
      @if (pdfService.currentFileName()) {
      <span class="font-medium">file: {{ pdfService.currentFileName() }}</span>
      @if (pdfService.hasChanges()) {
      <p-badge value="*"
               severity="warn"
               class="ml-2"></p-badge>
      } }
    </div>
    @if (!isElectron) {
    <p-fileUpload mode="basic"
                  accept=".pdf"
                  chooseLabel="Upload PDF"
                  (onSelect)="onFileSelect($event)"
                  [disabled]="pdfService.isLoading()"
                  class="p-button-outlined mr-2  justify-self-start">
    </p-fileUpload>
    }
  </p-toolbar>

  <!-- Loading spinner -->
  @if (pdfService.isLoading()) {
  <div class="loading-container">
    <p-progressSpinner></p-progressSpinner>
    <p>Loading PDF...</p>
  </div>
  }

  <!-- PDF Pages Grid with CDK Drag Drop -->
  @if (pdfService.pages().length > 0 && !pdfService.isLoading()) {
  <div class="pages-container">
    <div 
      class="pages-grid"
      cdkDropList
      [cdkDropListData]="pdfService.pages()"
      (cdkDropListDropped)="onPageDrop($event)"
      cdkDropListOrientation="mixed"
    >
      @for (page of pdfService.pages(); track page.pageNumber) {
      <div
        class="page-card"
        cdkDrag
        [cdkDragData]="{ page: page, index: $index }"
      >
        <!-- Custom drag preview -->
        <div class="page-drag-preview" *cdkDragPreview>
          <p-card class="drag-preview-card">
            <ng-template pTemplate="header">
              <div class="page-header">
                <span class="page-number">Page {{ $index + 1 }}</span>
              </div>
            </ng-template>
            <div class="page-content preview-content">
              <canvas
                [attr.width]="page.width * 0.5"
                [attr.height]="page.height * 0.5"
                #previewCanvas
              ></canvas>
            </div>
          </p-card>
        </div>

        <!-- Placeholder shown in the original position while dragging -->
        <div class="page-placeholder" *cdkDragPlaceholder>
          <div class="placeholder-content">
            <i class="pi pi-arrows-alt placeholder-icon"></i>
            <span class="placeholder-text">Drop page here</span>
          </div>
        </div>

        <!-- Actual page card -->
        <p-card>
          <ng-template pTemplate="header">
            <div class="page-header">
              <span class="page-number">Page {{ $index + 1 }}</span>
              <div class="page-actions">
                <p-button icon="pi pi-copy"
                          size="small"
                          (click)="duplicatePage($index)"
                          class="p-button-rounded p-button-text p-button-sm">
                </p-button>
                <p-button icon="pi pi-trash"
                          severity="danger"
                          size="small"
                          (click)="deletePage($index)"
                          class="p-button-rounded  p-button-text p-button-danger p-button-sm">
                </p-button>
              </div>
            </div>
          </ng-template>

          <div class="page-content">
            <canvas [attr.width]="page.width"
                    [attr.height]="page.height"
                    #canvas></canvas>
          </div>
        </p-card>
      </div>
      }
    </div>
  </div>
  }

  <!-- Empty state -->
  @if (pdfService.pages().length === 0 && !pdfService.isLoading()) {
  <div class="empty-state">
    <div class="empty-content">
      <i class="pi pi-file-pdf"
         style="font-size: 4rem; color: #6c757d;"></i>
      <h3>No PDF loaded</h3>
      <p>Open a PDF file to start organizing pages</p>
      <p-button label="Open PDF"
                icon="pi pi-folder-open"
                (click)="openPdf()"
                class="p-button-lg">
      </p-button>
    </div>
  </div>
  }

  <!-- Split PDF Dialog -->
  <p-dialog header="Split PDF"
            [(visible)]="showSplitDialog"
            [modal]="true"
            [responsive]="true"
            [style]="{ width: '50vw' }"
            [breakpoints]="{ '960px': '75vw', '640px': '90vw' }">
    <div class="split-dialog-content">
      <p>
        Select save location and enter page ranges to split the PDF into
        separate files:
      </p>

      <!-- Save Location Selector -->
      <div class="save-location-section">
        <label for="save-location"
               class="block text-sm font-medium mb-2">Save Location:</label>
        <div class="flex gap-2">
          <p-iconfield class="flex-1">
            <p-inputicon styleClass="pi pi-folder" />
            <input id="save-location"
                   type="text"
                   pInputText
                   [(ngModel)]="splitSaveLocation"
                   placeholder="Select folder to save split PDFs..."
                   class="w-full"
                   readonly />
          </p-iconfield>
          <p-button icon="pi pi-folder-open"
                    (click)="selectSaveLocation()"
                    class="p-button-outlined"
                    [disabled]="!isElectron">
          </p-button>
        </div>
        @if (!splitSaveLocation) {
        <small class="text-orange-600">Please select a save location before splitting the PDF.</small>
        }
      </div>

      @for (range of splitRanges; track $index) {
      <div class="split-range-item ">
        <div class="p-inputgroup gap-2">
          <span class="p-inputgroup-addon">Pages</span>
          <input type="number"
                 pInputText
                 placeholder="Start"
                 [(ngModel)]="range.start"
                 min="0"
                 [max]="pdfService.pages().length" />
          <span class="p-inputgroup-addon">to</span>
          <input type="number"
                 pInputText
                 placeholder="End"
                 [(ngModel)]="range.end"
                 min="1"
                 [max]="pdfService.pages().length" />
          <span class="p-inputgroup-addon">Filename</span>
          <input type="text"
                 pInputText
                 placeholder="filename.pdf"
                 [(ngModel)]="range.filename" />
          <p-button icon="pi pi-trash"
                    severity="danger"
                    (click)="removeSplitRange($index)"
                    class=" p-button-outlined p-button-rounded">
          </p-button>
        </div>
      </div>
      }

      <p-button label="Add Range"
                icon="pi pi-plus"
                (click)="addSplitRange()"
                class="p-button-outlined">
      </p-button>
    </div>

    <ng-template pTemplate="footer">
      <p-button label="Cancel"
                severity="secondary"
                text
                icon="pi pi-times"
                (click)="showSplitDialog = false"
                class="p-button-outlined">
      </p-button>
      <p-button label="Split PDF"
                icon="pi pi-check"
                (click)="executeSplit()"
                [disabled]="
              splitRanges.length === 0 || (isElectron && !splitSaveLocation)
            ">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Toast messages -->
  <p-toast></p-toast>

  <!-- Confirmation dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>